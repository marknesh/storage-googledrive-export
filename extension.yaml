name: storage-googledrive-export
version: 2.0.3
specVersion: v1beta

displayName: Export Storage Files to Google Drive

description: >-
  Exports cloud storage files to google drive in real-time.

author:
  authorName: Mark
  url: https://github.com/marknesh

icon: icon.png
tags: [utilities]

license: Apache-2.0

sourceUrl: https://github.com/marknesh/storage-googledrive-export

billingRequired: true

apis:
  - apiName: drive.googleapis.com
    reason: Exports files from your Cloud Storage bucket to Google Drive.

roles:
  - role: storage.admin
    reason: Allows the extension to export files in Cloud Storage to Google Drive.

resources:
  - name: exportToDrive
    type: firebaseextensions.v1beta.function
    description: >-
      Storage triggered function that exports an uploaded file to google drive.
    properties:
      location: ${param:LOCATION}
      eventTrigger:
        eventType: google.storage.object.finalize
        resource: projects/_/buckets/${BUCKET_NAME}
        failurePolicy: { retry: {} }
      runtime: "nodejs18"
      maxInstances: 1
      timeout: 540s

  - name: fileTask
    type: firebaseextensions.v1beta.function
    description: >-
      Function that exports all existing
    properties:
      location: ${param:LOCATION}
      runtime: nodejs18
      taskQueueTrigger:
        rateLimits:
          maxConcurrentDispatches: 1
        retryConfig:
          maxBackoffSeconds: 60
      timeout: 540s

params:
  - param: BUCKET_NAME
    label: Cloud Storage bucket
    description: Which bucket do you want use? This field is optional, we will use the default bucket if left empty.
    type: selectResource
    resourceType: storage.googleapis.com/Bucket
    default: ${STORAGE_BUCKET}
    required: false

  - param: FOLDER_PATH
    label: Cloud Storage folder (Not including heading slash)
    description:
      Which folder do you want to listen to upload changes? Leave empty if you want to upload all files to Google Drive. Enter the full paths of the folders separated by commas.
      e.g `users/photos,gallery` or use curly braces for dynamic folders e.g `users/{userId}/images, projects/{projectId}/files`
    type: string
    required: false

  - param: FOLDER_ID
    label: Google drive Folder ID
    description: >-
      The ID of the folder in google drive where you want to export your files.
      This can be found in the url after creating or accessing the folder e.g `https://drive.google.com/drive/u/0/folders/{FOLDER_ID}`
    type: string
    required: true
    immutable: false

  - param: FILE_TYPES
    label: Allowed MIME types
    description: >-
      The MIME types of the files you want to upload to Google drive. The most common MIME types can be
      referenced [here](https://developer.mozilla.org/en-US/docs/Web/HTTP/Basics_of_HTTP/MIME_types/Common_types).
      This field is `optional` e.g `image/jpeg` or to allow more than one MIME type, please separate each type with a comma e.g `image/jpeg,video/mp4`
    type: string
    required: false
    immutable: false

  - param: EXCLUDE_FILE_NAME_CONTAINS
    label: Exclude File Names with These Words
    description: >-
      Enter words or parts of file names to skip uploading certain files.  
      If a file name includes any of these, it won't be uploaded.  
      Example: `_500x500,_200x200`. This field is optional.
    type: string
    required: false
    immutable: false

  - param: MAXIMUM_FILE_SIZE
    label: Maximum file size to upload
    description: >-
      The maximum file size to upload to google drive in megabytes(MB). e.g `200`
      This field is `optional`.
    type: string
    required: false
    immutable: false

  - param: USE_FOLDER_STRUCTURE
    label: Do you want to use the existing folder structure?
    description: >-
      Do you want the uploaded files to follow the folder structure in cloud storage e.g if there
      is a sub-folder, it will also create a sub-folder. If this option is not allowed, only the file will be created, without the sub-folders.
    type: select
    required: true
    immutable: false
    options:
      - label: Yes
        value: true
      - label: No
        value: false

  - param: EMAIL_ADDRESS
    label: The email address of the google drive account in which you added the service account.
    description: >-
      The email address of the google drive account in which you added the service account. This allows you to view sub-folders in google drive.
    required: true
    immutable: false

events:
  - type: mark.storage-googledrive-export.v1.complete
    description: Occurs when uploading to google drive completes.
